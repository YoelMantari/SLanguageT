<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Backend - ConnectSigns</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      video {
        width: 100%;
        max-width: 640px;
        border: 2px solid #333;
        transform: scaleX(-1);
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
      }
      #status {
        margin-top: 20px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 5px;
      }
      #result {
        margin-top: 20px;
        padding: 15px;
        background: #e8f5e9;
        border-radius: 5px;
        font-size: 18px;
        font-weight: bold;
      }
      .log {
        margin-top: 20px;
        padding: 10px;
        background: #000;
        color: #0f0;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>ü§ü Test Backend ConnectSigns</h1>

    <div>
      <button onclick="startCamera()">üìπ Iniciar C√°mara</button>
      <button onclick="stopCamera()">‚èπ Detener C√°mara</button>
      <button onclick="startDetection()">üîç Iniciar Detecci√≥n</button>
      <button onclick="stopDetection()">‚è∏ Detener Detecci√≥n</button>
    </div>

    <div style="margin-top: 20px">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display: none"></canvas>
    </div>

    <div id="status">Estado: Esperando...</div>
    <div id="result">Resultado: ---</div>

    <div class="log" id="log"></div>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const statusDiv = document.getElementById("status");
      const resultDiv = document.getElementById("result");
      const logDiv = document.getElementById("log");

      let stream = null;
      let ws = null;
      let detectionInterval = null;

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
          });
          video.srcObject = stream;
          statusDiv.textContent = "‚úì C√°mara iniciada";
          log("‚úì C√°mara iniciada exitosamente");
        } catch (error) {
          statusDiv.textContent = "‚úó Error al iniciar c√°mara";
          log("‚úó Error: " + error.message);
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
          statusDiv.textContent = "C√°mara detenida";
          log("C√°mara detenida");
        }
      }

      function startDetection() {
        if (!stream) {
          alert("Primero inicia la c√°mara");
          return;
        }

        // Conectar WebSocket
        ws = new WebSocket("ws://localhost:8000/ws/detect");

        ws.onopen = () => {
          statusDiv.textContent = "‚úì Conectado al servidor";
          log("‚úì WebSocket conectado");

          // Iniciar env√≠o de frames
          detectionInterval = setInterval(sendFrame, 100);
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          log("üì© Respuesta recibida: " + JSON.stringify(data));

          if (data.type === "detection") {
            const result = data.data;
            if (result.sign) {
              resultDiv.textContent = `Se√±a: ${result.sign} (${(
                result.confidence * 100
              ).toFixed(1)}%)`;
              resultDiv.style.background = "#c8e6c9";
            } else {
              resultDiv.textContent = result.message;
              resultDiv.style.background = "#fff9c4";
            }
            statusDiv.textContent = `${result.message} | Buffer: ${result.buffer_status}`;
          }
        };

        ws.onerror = (error) => {
          log("‚úó Error WebSocket: " + error);
          statusDiv.textContent = "‚úó Error de conexi√≥n";
        };

        ws.onclose = () => {
          log("WebSocket cerrado");
          statusDiv.textContent = "Desconectado";
        };
      }

      function stopDetection() {
        if (detectionInterval) {
          clearInterval(detectionInterval);
          detectionInterval = null;
        }
        if (ws) {
          ws.close();
          ws = null;
        }
        statusDiv.textContent = "Detecci√≥n detenida";
        log("Detecci√≥n detenida");
      }

      function sendFrame() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          log("‚ö† WebSocket no est√° abierto");
          return;
        }

        const context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL("image/jpeg", 0.8);

        ws.send(
          JSON.stringify({
            type: "frame",
            image: imageData,
          })
        );

        log("üì∏ Frame enviado (" + imageData.length + " bytes)");
      }

      // Limpiar al cerrar
      window.addEventListener("beforeunload", () => {
        stopDetection();
        stopCamera();
      });
    </script>
  </body>
</html>
